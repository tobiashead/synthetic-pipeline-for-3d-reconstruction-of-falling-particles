import sys
import os
from pathlib import Path
import matplotlib.pyplot as plt 
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..')))
from src.pipeline_utils import (
    GetEvaluationAndImageDirAndObjPath,
    ImportCameras,
    ScaleScene
    )

def EvaluateReconstruction(output_dir,scaling_params,DisplayPlots=False,ImageObjectPathList = None):
    evaluation_dir, image_dir, obj_path = GetEvaluationAndImageDirAndObjPath(output_dir,ImageObjectPathList)             
    cams_rec, cams_ref = ImportCameras(output_dir,image_dir)
    _,dict_scaling, fig = ScaleScene(cams_rec,cams_ref,evaluation_dir,scaling_params,DisplayPlots,extract_plot= True)
    
    mean = dict_scaling["mean"]
    median = dict_scaling["median"]
    ax = fig.get_axes()[0]
    legend = ax.legend()  # Ruft das Legend-Objekt ab
    text = ax.texts[0]
    mean_legend, med_legend = legend.get_texts()
    fig.set_size_inches(4.5,3.5)
    ax.set_ylabel("HÃ¤ufigkeit",fontsize=10)
    ax.set_xlabel("Skalierungsfaktor s",fontsize=10)
    
    mean_legend.set_text(f"Mittelwert: {mean:.4f}")
    mean_legend.set_fontsize(10)
    med_legend.set_text(f"Median: {median:.4f}")
    med_legend.set_fontsize(10)
    text.set_position([55,185])
    text.set_fontsize(10)
    ax.tick_params(axis='both', which='major', labelsize=10)
    fig.tight_layout()
    fig.show()
    #stop by breakpoint in line 36
    print("hello")
    
    
if __name__ == "__main__":
    output_dir = r"C:\Users\Tobias\Desktop\Distance_3cam_rotY400_ObjectCenter_13"     # File path to the folder where the meshroom data is located
    ImageObjectPathList  = [
        Path(output_dir) / "Images",
        Path(output_dir) / r"InputObject\GRAU5_centered.obj"
    ]
    
    scaling_params = {        
        "PreOutlierDetection": True,
        "threshold": 0.05,
        "criterion": "rel"      # criterion="abs","abs_norm" or "rel",
        # relative criterion: threshold = 0.07 --> 7%,    absolute normed criterion: threshold: 0.1m   --> measured on the scale of the reconstruction program --> ca. 2cm (real scale)
        # absolute criterion: treshold: 0.1m
    }
    
    EvaluateReconstruction(output_dir,scaling_params,DisplayPlots=False,ImageObjectPathList = ImageObjectPathList)